const Config={t:"DooHTML",o:"data-bind",l:"data-template",p:{T:-1,i:0,m:1},u:{BEG:"{{",END:"}}"},N:"data-key",A:"key"},version="v0.98.2",getItemValue=(e,t)=>t.includes(".")?t.split(".").reduce(((e,t)=>e&&void 0!==e[t]?e[t]:""),e):e[t]?e[t]:"",getNode=(e,t)=>t.reduce(((e,t)=>e?.childNodes[t]||null),e),isTable=e=>["TABLE","TBODY","THEAD","TFOOT","TR","TH"].includes(e.tagName),render=(e,t,o=0)=>{0!==t.length?renderHTML(e,t,o):e.textContent=""},renderHTML=(e,t,o=0,n=null)=>{let a=t.length;const l=e;let r=n?o+a:a-o;r>a&&(r=a);const d=l.D.length,c=(e,o)=>{for(let n=0;n<d;n++){const a=getNode(e,l.D[n][1]);a?"textContent"===l.D[n][2]?a.textContent=t[o][l.D[n][0]]:a.setAttribute(l.D[n][2],t[o][l.D[n][0]]):console.info("Field:"+l.D[n][0]+" does not exist")}},s=l[Config.A];for(let n=o;n<r;++n)c(e.C,n),l.appendChild(e.C.cloneNode(!0))[Config.A]=getItemValue(t[n],s)},append=(e,t,o=0)=>{renderHTML(e,t,o,t.length-o)},dooParse=e=>{let t=e.cloneNode(!0);t.removeAttribute(Config.o),t.removeAttribute("data-key");let o=t.outerHTML.replace(/\t/g,"").replace(/\n/g,""),n=o;["src","selected","checked","disabled","readonly"].forEach((e=>{o=o.replace(new RegExp(" "+e+'="{{(.+)}}"',"g")," doo-"+e+'="{{$1}}"')}));let a=n===o,l=document.createElement("template");l.innerHTML=o;let r=[];const d=(e,t,o)=>{let n=[],a=e;for(;a!==l.firstElementChild;){let e=a.previousSibling,t=0;for(;e;)t++,e=e.previousSibling;a=a.parentNode,a&&n.unshift(t)}r.push([t,n.slice(1),o])},c=document.createTreeWalker(l.content,NodeFilter.SHOW_TEXT,{acceptNode:()=>NodeFilter.FILTER_ACCEPT});let s=c.nextNode(),p=[];for(;s;){let e=s.wholeText.trim();if(0===e.indexOf("{{")&&e.lastIndexOf("}}")===e.length-2);else{let t=e.replace(/{{/g,"<span>{{").replace(/}}/g,"}}</span>");p.push({node:s.parentNode,L:e,h:t})}s=c.nextNode()}for(let e=0,t=p.length;e<t;e++)p[e].node.innerHTML=p[e].node.innerHTML.replace(p[e].L,p[e].h);let T=l.content.cloneNode(!0);const i=document.createTreeWalker(T,NodeFilter.SHOW_TEXT,{acceptNode:()=>NodeFilter.FILTER_ACCEPT});let m=i.nextNode();for(;m;){const e=m.nodeValue.match(/\{\{(.*?)\}\}/g);if(e){const t=m.parentNode;e.forEach((e=>{const o=e.replace(/\{\{|\}\}/g,"").trim(),n=document.createTextNode(o);m.textContent="";const a=t.appendChild(n);d(a,o,"textContent")}))}m=i.nextNode()}const f=document.createTreeWalker(T,NodeFilter.SHOW_ELEMENT,{acceptNode:()=>NodeFilter.FILTER_ACCEPT});for(m=f.nextNode();m;){for(const e of[...m.attributes])e.nodeValue.includes("{{")&&d(m,e.nodeValue.replace("{{","").replace("}}",""),e.name);m=f.nextNode()}let u=T.firstElementChild.outerHTML;return r.forEach((e=>{let t="{{"+e[0]+"}}";u=u.replace(new RegExp(t,"g"),"")})),T.outerHTML=u,{C:T.firstElementChild,v:a,D:r}},fetchTemplate=e=>new Promise(((t,o)=>{const n=new XMLHttpRequest;n.open("GET",e),n.onload=()=>t(n.responseText),n.onerror=()=>o(n.statusText),n.send()})),setReactiveDataNodes=e=>{const t=[],o=e=>{let t=0;for(;e.parentElement;)e=e.parentElement,t++;return t},n=e.content.querySelectorAll(`[${Config.o}]`);n.forEach((t=>{t.hasAttribute("data-src")||t.setAttribute("data-src",e.hasAttribute("doo-dispatch")?"DooX":Config.o),t.removeAttribute("data-src")})),(e=>{[...e].map((e=>({H:e,level:o(e),R:e.getAttribute("data-src")?.startsWith("this.parent"),F:e.hasAttribute("data-norepeat")}))).sort(((e,t)=>t.level-e.level)).forEach((({H:e,level:o,R:n,F:a},l)=>{const r="|STYLE|LINK|".includes(`|${e.tagName}|`)?e:(e.parentElement&&"|DL|UL|TBODY|THEAD|TFOOT|TR|SELECT|SECTION|".includes(`|${e.parentElement.tagName}|`),e.parentElement),d=dooParse(e);Object.assign(r,{C:d.C,v:d.v,D:d.D,name:l,level:o,R:n,F:a,I:isTable(r)}),"DATA"!==r.tagName&&"STYLE"!==r.tagName&&"LINK"!==r.tagName||e.parentElement?.replaceChild(r,e)||console.warn("Templates should only have one child node"),t.push(r)}))})(n),e.place=t},prefetchTemplate=async e=>{if(e&&(e.startsWith("./")||e.startsWith("../")||e.startsWith("http"))){return await fetchTemplate(e)}return null},createTemplate=async(e,t=[],o=null)=>{let n=o?await prefetchTemplate(o):"";n||(n=e.startsWith("<")?e:e.startsWith("#")?document.querySelector(e).outerHTML:document.querySelector("#"+e).outerHTML);const a=document.createElement("div");a.innerHTML=n,a.querySelector("template")&&(a.innerHTML=a.querySelector("template")?n:`<template><center><pre>The template you are trying to import does not have a &lt;template&gt; tag</pre><div style="color:red">${n}</div></center></template>`);const l=a.querySelector("template").cloneNode(!0),r=document.createElement("template");l.removeAttribute("id"),r.innerHTML=l.innerHTML,setReactiveDataNodes(r);const d=document.querySelector(`[data-template="${e}"]`);return r.place[0].textContent="",r.place[0][Config.A]=d.dataset[Config.A],d.parentElement.replaceChild(r.content,d),t.length>0&&render(r.place[0],t,0),r.place[0]};export{createTemplate,append,render,Config,version,prefetchTemplate};