export default(async(e={})=>{try{let t=cloneObj(e);if(t.url=t.url??coreData.api?.url??"/",t.method=t.method??coreData.api?.method??"POST",t.headers=t.headers??!1,t.format=t.format??coreData.api?.format??!1,isStr(t.method)&&(t.method=t.method.toUpperCase()),isObj(t.headers)&&isStr(t.headers["Content-Type"])&&(t.headers["Content-Type"]=t.headers["Content-Type"].toLowerCase()),isStr(t.format)&&(t.format=t.format.toLowerCase(),t.format="formdata"===t.format?"formData":t.format,t.format="arraybuffer"===t.format?"arrayBuffer":t.format),t.body=t.hasOwnProperty("body")?t.body:null,!t.headers?.Authorization){let a=localStorage.getItem("token");a&&(t.headers={...t.headers,Authorization:`Bearer ${a}`})}let r=["GET","HEAD","DELETE","OPTIONS","TRACE"];isElem(t.body)&&(t.body=await formObj(t.body));let o=t.body&&isObj(t.body)&&r.includes(t.method)?`${t.url}${t.url.includes("?")?"&":"?"}${String(new URLSearchParams(Object.entries(t.body)))}`:t.url,n={};for(let d in t)t.hasOwnProperty(d)&&t[d]&&(!["url","format","body","cache"].includes(d)||"cache"===d&&isStr(t[d]))&&(n[d]=t[d]);if(!r.includes(t.method)){if(isObj(t.body)){if(n.headers?.["Content-Type"]&&!n.headers["Content-Type"].startsWith("multipart/form-data")){let i={"application/json":()=>JSON.stringify(t.body),"application/x-www-form-urlencoded":()=>String(new URLSearchParams(Object.entries(t.body))),default:()=>t.body},s=(i[n.headers["Content-Type"]]||i.default)();n.body=isObj(s)?JSON.stringify(s):String(s)}else n.body=Object.entries(t.body).reduce((e,[t,a])=>(isArr(a)?(t=t.endsWith("[]")?t.trim():`${t.trim()}[]`,a.forEach(a=>e.append(t,a))):e.append(t,a),e),new FormData)}else n.headers={...n.headers,"Content-Type":"text/plain"},n.body=null===t.body?"":t.body}let l=async(e=null)=>{let a=await fetch(o,n),r=!1,d=null;if(a.ok&&(t.format&&isFn(a[t.format])?r=await a[t.format]():(r=await a.text(),r=parseJson(r)||r),d=r,isObj(r)&&r.hasOwnProperty("token")&&localStorage.setItem("token",r.token),e)){if(hasNum(coreData.cache?.api)){let i=null,s=1/0,l=0;for(let h=0;h<localStorage.length;h++){let f=localStorage.key(h);if(f.startsWith("apiCache_")){l++;let m=parseJson(localStorage.getItem(f));m[0]<s&&(s=m[0],i=f)}}l>=coreData.cache.api&&localStorage.removeItem(i)}localStorage.setItem(e,JSON.stringify([Math.floor(Date.now()/1e3),r]))}return!1===r?console.warn("Failed to make a request: ",t):coreData.events?.api&&evt.run("api",{request:t,response:d}),r},h=!!(t.cache&&hasNum(t.cache)),f=h?`apiCache_${await [t.url,t.method,n.headers?.["Content-Type"]??!1,t.format??!1,t.body??!1].hash()}`:null,m=h?parseJson(localStorage.getItem(f)):null;if(m&&m[0]>Math.floor(Date.now()/1e3)-t.cache)return coreData.events?.api&&evt.run("api",{request:t,response:m[1]}),m[1];return l(f)}catch{return console.warn("Failed to make a request: ",e),!1}});