export default(async(e={})=>{try{if(Object.assign(e,{url:e.url??coreData.api?.url??"/",method:e.method??coreData.api?.method??"POST",headers:e.headers??!1,body:e.body??null,format:e.format??coreData.api?.format??!1,polling:e.polling??!1,credentials:e.credentials??!1,progress:e.progress??!1,response:e.response??!1}),isStr(e.method)&&(e.method=e.method.toUpperCase()),isStr(e.format)&&(e.format=e.format.toLowerCase()),isObj(e.headers)&&isStr(e.headers["Content-Type"])&&(e.headers["Content-Type"]=e.headers["Content-Type"].toLowerCase()),!e.headers?.Authorization){let t=localStorage.getItem("token");t&&(e.headers={...e.headers,Authorization:`Bearer ${t}`})}let o=["GET","HEAD","DELETE","OPTIONS","TRACE"],r=cloneObj({url:e.url,headers:e.headers,body:e.body});if(isElem(r.body)&&(r.body=await formObj(r.body)),r.url=isObj(r.body)&&o.includes(e.method)?`${r.url}${r.url.includes("?")?"&":"?"}${String(new URLSearchParams(Object.entries(r.body)))}`:r.url,!o.includes(e.method)){if(isObj(r.body)){if(r.headers?.["Content-Type"]&&!r.headers["Content-Type"].startsWith("multipart/form-data")){let a={"application/json":()=>JSON.stringify(r.body),"application/x-www-form-urlencoded":()=>String(new URLSearchParams(Object.entries(r.body))),default:()=>r.body},d=(a[r.headers["Content-Type"]]||a.default)();r.body=isObj(d)?JSON.stringify(d):String(d)}else r.body=Object.entries(r.body).reduce((e,[t,o])=>(isArr(o)?(t=t.endsWith("[]")?t.trim():`${t.trim()}[]`,o.forEach(o=>e.append(t,o))):e.append(t,o),e),new FormData)}else r.headers={...r.headers,"Content-Type":"text/plain"},r.body=null===r.body?"":r.body}let s=await new Promise(t=>{let a=new XMLHttpRequest;if(["json","text","blob","arraybuffer","document"].includes(e.format)&&(a.responseType=e.format),a.open(e.method,r.url,!0),isObj(r.headers))for(let d in r.headers)r.headers.hasOwnProperty(d)&&a.setRequestHeader(d,r.headers[d]);e.credentials&&(a.withCredentials=!0),isFn(e.progress)&&(a.upload.onprogress=t=>{t.lengthComputable&&e.progress.call(e,{type:"upload",loaded:t.loaded,total:t.total,percent:parseFloat((t.loaded/t.total*100).toFixed(2))})},a.onprogress=t=>{t.lengthComputable&&e.progress.call(e,{type:"download",loaded:t.loaded,total:t.total,percent:parseFloat((t.loaded/t.total*100).toFixed(2))})}),a.onload=()=>t(a),o.includes(e.method)?a.send():a.send(r.body)}),n=!1,l=null;return s.status>=200&&s.status<300&&(l=n=e.format?s.response:parseJson(s.response)||s.response,isObj(n)&&n.hasOwnProperty("token")&&localStorage.setItem("token",n.token)),!1===n?console.warn("Failed to make a request: ",e):(e.response.call(e,n),coreData.events?.stream&&evt.run("stream",{request:e,response:l})),(!0===e.polling||isNum(e.polling))&&(hasNum(e.polling)&&await sleep(e.polling),await stream(e)),!0}catch{return console.warn("Failed to make a request: ",e),!1}});