export default(async(t=null,e=null)=>{let l=t=>{let e=$(`[data-tpl="${t}"]:not(template) ?`);if(!e.length)return null;{let l=e.map(t=>t.$(":: ?").map(t=>({it:t,data:toBuild(t.dataset.set)||null}))),a=(t,e)=>({it:t,fields:e<l.length?l[e]:[]});return 1===e.length?a(e[0],0):e.map((t,e)=>a(t,e))}},a=()=>{let t=new Set,e={};for(let a in $("[data-tpl]:not(template) ?").map(a=>{let i=a.dataset.tpl.replace(/\s/g,"");if(!t.has(i)){let n=l(i);n&&(e[i]=n,t.add(i))}}),e)e.hasOwnProperty(a)&&isArr(e[a])&&(e[a]=e[a][0]||{});return hasObj(e)?e:null},i=(t,e=null)=>{if(!isElem(t))return null;let l=t.$("..{[data-tpl]}");if(!l)return null;let a=l.$(":: ?"),i=a.findIndex(e=>e.contains(t)),n={tpl:l,name:l.dataset.tpl.replace(/\s/g,""),field:-1!==i?a[i]:null,idx:i};return isFn(e)&&e(n),n},n=t=>t.length?t[0]:null,r=t=>t.length?1===t.length?t[0]:t:null,s=(t,e)=>t?e.filter(e=>e<t):[],d=(t,e)=>t?t.map((t,e)=>({val:t,idx:e})).filter(({val:t})=>Object.keys(e||[]).every(l=>isReg(e[l])?e[l].test(t.data[l]):toArr(e[l]).map(String).includes(String(t.data[l]).toLowerCase().trim()))).map(({idx:t})=>t):[],f=(t,e)=>(e=isNum(e)?[e]:e)&&hasArr(e)?s(t?t.length:0,e):d(t,e||[]),p=(t,e)=>{let l=[...t].filter((t,l)=>l!==e);return l[1]=isNum(l[1])?[l[1]]:l[1],l},u=(t,e=!1)=>{let l=$(`[data-tpl-alt="${t.it.dataset.tpl}"] ?`),a=e||hasArr(t.fields)?"true":"false",i=()=>{t.it.attr.toggle("inert","true"!==a),hasArr(l)&&l.attr.toggle("inert","true"===a)};coreData.duration?setTimeout(i,coreData.duration):i()},o={getTpl(t,e=!1){let a=l(t[0].replace(/\s/g,""));if(!a)return null;if(a=toArr(a),t.length>1){let s=!!(isElem(t[1])||hasArr(t[1])&&isElem(t[1][0]));s&&(t[1]=isElem(t[1])?[t[1]]:t[1],t[1].forEach((t,e,l)=>l[e]=l[e].$("..{[data-set]}")||i(l[e])?.field)),a.forEach(e=>{hasArr(e.fields)&&(e.fields=s?e.fields.filter(e=>t[1].includes(e.it)):f(e.fields,t[1]??[]).map(t=>e.fields[t]).filter(Boolean),e.fields=e.fields.length?e.fields:[])})}return e?r(a):n(a)},addTpl(t,e=!1){t=t.flatMap(t=>isArr(t)?t:[t]);let l=t[0].replace(/\s/g,""),a=$(`template[data-name="${l.split(":")[0]}"]`),i=$(`[data-tpl="${l}"]:not(template) ?`);if(!a||!hasArr(i))return null;let n=1===i.length?{it:i[0],fields:[]}:i.map(t=>({it:t,fields:[]}));if(!n)return null;n=toArr(n),t.shift();let s=t[t.length-1];(isStr(s)||isNum(s))&&t.pop(),"begin"===(s=isNum(s)?s<0?"end":s:isStr(s)&&["begin","end"].includes(s)?s:"end")&&(t=t.reverse()),t=hasArr(t)?t:[{}];let d=document.createElement("div");d.appendChild(a.content.cloneNode(!0)),1===d.$(":: ?").length&&(d=d.$("*")),d.innerHTML=d.innerHTML.replace(/>([^<]+)</g,t=>t.replace(/\$\{([^}]+)\}/g,(t,e)=>"<span data-set-txt-"+e+">${"+e+"}</span>"));let f=d.$("?"),p=[];f.unshift(d),f.forEach(t=>{let e=t.attr.get();if(e){for(let l in e)if(e.hasOwnProperty(l)&&/\$\{.*\}/.test(e[l])){if("class"===l){let a=[];(e[l].split(" ").map(t=>t.trim())||[]).forEach(t=>{let e=t.match(/^\$\{(.*?)\}$/);e&&e[1]&&!a.includes(e[1])&&a.push(e[1])}),t.setAttribute("data-set-cls",a.join(", "))}else if(!["data-set-attr","data-set-cls"].includes(l)){let i=e[l].match(/^\$\{(.*?)\}$/);if(i&&i[1]){let n=p.find(e=>e.it===t);n?n.data.push({name:i[1],attr:l}):p.push({it:t,data:[{name:i[1],attr:l}]})}}}}}),p.forEach(t=>{t.data?.length&&t.it.setAttribute("data-set-attr",t.data.map(t=>`${String(t.name).replace(/"/g,"&quot;")}: '${("object"==typeof t.attr&&null!==t.attr?JSON.stringify(t.attr):String(t.attr)).replace(/"/g,"&quot;")}'`).join(", "))}),d.dataset.set="{{set}}";let u=d.outerHTML,o="";t.forEach(t=>o+=u.replace(/{{set}}/,Object.entries(t).map(([t,e])=>`${t}: '${("object"==typeof e&&null!==e?JSON.stringify(e):String(e)).replace(/"/g,"&quot;")}'`).join(", ")).replace(/\$\{(.*?)\}/g,(e,l)=>l in t?"object"==typeof t[l]&&null!==t[l]?JSON.stringify(t[l]):t[l]:""));let g=[];return n.forEach(l=>{if(e&&(l.it.innerHTML=""),"end"===s)l.it.html(o,s);else{let a="begin"!==s?l.it.$(":: ?"):[],i="begin"===s?"begin":isNum(s)&&a.length>s?"before":"end";("before"===i?a[s]:l.it).html(o,i)}let n=l.it.$(":: ?"),r=t.length,d="begin"===s?n.slice(0,r):isNum(s)?n.slice(n.length<r+s?0:s,s+r):n.slice(-r);g.push(...d.map(t=>({it:t,data:toBuild(t.dataset.set)||null})))}),i.attr.toggle("inert",!1),$(`[data-tpl-alt="${l}"] ?`)?.attr.toggle("inert",!0),g.length&&init("tpl"),r(g)},replaceTpl:t=>o.addTpl(t,!0),setTpl(t){if(t.length<2||"object"!=typeof t[1]||null===t[1])return null;let e=[];t[0]=t[0].replace(/\s/g,"");let a=l(t[0]);if(!a)return null;let n=!1;a=toArr(a);let r=!!(isElem(t[2])||hasArr(t[2])&&isElem(t[2][0]));r&&(t[2]=isElem(t[2])?[t[2]]:t[2],t[2].forEach((t,e,l)=>l[e]=l[e].$("..{[data-set]}")||i(l[e])?.field));let s=e=>{var l,a;for(let i in t[1]=(l=t[1],a=e.data,Object.fromEntries(Object.entries(l).map(([t,e])=>[t,e.replace(/\${(.*?)}/g,(t,e)=>a[e]??"")]))),t[1])t[1].hasOwnProperty(i)&&e.it.$(`span[data-set-txt-${i}] ?`).forEach(e=>{e.$("..{[data-tpl]}")?.dataset.tpl===t[0]&&(e.innerHTML=t[1][i])});return e.it.$("[data-set-cls] ?").forEach(l=>{if(l.$("..{[data-tpl]}")?.dataset.tpl===t[0]){let a=l.getAttribute("data-set-cls");a&&(a.split(",").map(t=>t.trim())||[]).forEach(a=>{t[1].hasOwnProperty(a)&&(e.data.hasOwnProperty(a)&&l.classList.remove(e.data[a]),l.classList.add(t[1][a]))})}}),e.it.$("[data-set-attr] ?").forEach(e=>{if(e.$("..{[data-tpl]}")?.dataset.tpl===t[0]){let l=e.getAttribute("data-set-attr");if(l&&"object"==typeof(l=toBuild(l))&&null!==l)for(let a in l)l.hasOwnProperty(a)&&t[1].hasOwnProperty(a)&&e.setAttribute(l[a],String(t[1][a]).replace(/"/g,"&quot;"))}}),e.data=Object.assign(e.data,t[1]),e.it.dataset.set=Object.entries(e.data).map(([t,e])=>`${t}: '${String(e).replace(/"/g,"&quot;")}'`).join(", "),e};return a.forEach(l=>{if(hasArr(l.fields)){let a=r?l.fields.filter(e=>t[2].includes(e.it)):f(l.fields,t[2]??[]).map(t=>l.fields[t]).filter(Boolean);a.forEach(t=>{t=s(t),n||e.push(t)})}n=!0}),e.length&&init("tpl"),e},removeTpl(t){let e=t[0].replace(/\s/g,"");if(!e)return null;if(1===t.length){let a=$(`[data-tpl="${e}"]:not(template) ?`);return a?.html(""),a?.attr.toggle("inert",!0),$(`[data-tpl-alt="${e}"] ?`)?.attr.toggle("inert",!1),{it:a[0],fields:[]}}if(isElem(t[1])||hasArr(t[1])&&isElem(t[1][0])){let r=[];t[1]=isElem(t[1])?[t[1]]:t[1],t[1].forEach(t=>{let e=t.$("..{[data-set]}")||i(t)?.field;e&&(coreData.duration?(e.attr.toggle("inert",!0),setTimeout(()=>e.remove(),coreData.duration)):e.remove(),r.push(e))});let s=l(e);return s?((s=toArr(s)).forEach(t=>{if(hasArr(t.fields))for(let e=t.fields.length-1;e>=0;e--)r.includes(t.fields[e].it)&&t.fields.splice(e,1);u(t,!1)}),n(s)):null}{let d=l(e);return d?((d=toArr(d)).forEach(e=>{if(hasArr(e.fields)){let l=f(e.fields,t[1]??[]);coreData.duration?l.forEach(t=>{if(e.fields[t]){let l=e.fields[t].it;l.attr.toggle("inert",!0),setTimeout(()=>l.remove(),coreData.duration),e.fields[t]=null}}):l.forEach(t=>{e.fields[t]&&(e.fields[t].it.remove(),e.fields[t]=null)}),e.fields=e.fields.filter(t=>hasObj(t)),e.fields=e.fields.length?e.fields:[]}u(e,!1)}),n(d)):null}},swapTpl(t){if(t.length<3)return null;if(isNum(t[1],t[2])){let e=$(`[data-tpl="${t[0]}"] :: ?`),l=e[t[1]],a=e[t[2]];return l&&a&&l!==a&&$.swap(l,a),[{it:l,data:toBuild(l?.dataset.set)||null},{it:a,data:toBuild(a?.dataset.set)||null}]}{let i=toArr(o.getTpl(p(t,2),!0)),n=toArr(o.getTpl(p(t,1),!0)),r=i.map(t=>t?.fields?.[0]||null),s=n.map(t=>t?.fields?.[0]||null),d=Math.min(r?.length,s?.length);r.length=s.length=d;let f=null;return r.forEach((t,e)=>{t?.it&&s[e]?.it&&t.it!==s[e].it&&($.swap(t.it,s[e].it),null===f&&(f=[t,s[e]]))}),f}},countTpl(t){if(t.length>1){let e=o.getTpl(t);return e?.fields?e.fields.length:0}{let l=$(`[data-tpl="${t[0]}"]:not(template)`);return isElem(l)?l.$(":: ?").length:0}},async componentTpl(t){if(t.length<=1)return null;let e=[...t];e.splice(1,1);let l=o.getTpl(e);if(!l)return null;l=toArr(l);let a={};await Promise.all(l.map(async e=>{if(hasArr(e.fields)){if("object"==typeof t[1]&&null!==t[1])for(let[l,i]of Object.entries(t[1])){let n=await component[l](e.fields,i);a[l]=n}else{let r=await component[t[1]](e.fields,null);a[t[1]]=r}}})),a.length&&init("tpl");let i=len(a);return i?1===i?Object.values(a)[0]:a:null}};return hasArr(e)?"pos"===t?i(...e):!!(e[0]&&o.hasOwnProperty(`${t}Tpl`))&&await o[`${t}Tpl`](e):"get"===t&&a()});